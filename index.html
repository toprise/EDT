<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>通用加密解密工具</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    :root {
      --bg-light:#eaf6ff; --header-light:#cfe8fc; --btn-light:#a5d8ff;
      --bg-pink:#fff0f5; --header-pink:#ffd3e0; --btn-pink:#ffb0c9;
      --bg-dark:#2c2c2e; --header-dark:#3a3a3c; --btn-dark:#5e5e60;
      --txt-light:#333; --txt-dark:#f2f2f7;
    }
    body {
      font-family:'Noto Sans SC',sans-serif;
      margin:30px; display:flex; flex-direction:column; align-items:center;
      background:var(--bg-light); color:var(--txt-light);
    }
    body.dark {
      background:var(--bg-dark); color:var(--txt-dark);
    }
    .theme-card, .card {
      width:800px; border-radius:20px;
      box-shadow:0 8px 20px rgba(0,0,0,0.15); transition:.3s;
    }
    .theme-card {
      display:flex; justify-content:flex-end; gap:10px; padding:15px;
      margin-bottom:20px; background:var(--header-light);
    }
    .theme-card.dark { background:var(--header-dark); }
    .theme-btn, .lang-select {
      border:none; border-radius:12px; padding:8px 16px;
      background:#eee; cursor:pointer; transition:.3s;
      font-size:14px; color:#333;
    }
    .theme-card.dark .theme-btn,
    .theme-card.dark .lang-select {
      background:var(--btn-dark); color:var(--txt-dark);
    }
    .theme-btn.selected.blue { background:var(--btn-light); color:#fff; }
    .theme-btn.selected.pink { background:var(--btn-pink); color:#fff; }

    .tabs {
      display:flex; background:var(--header-light);
    }
    .tabs.dark { background:var(--header-dark); }
    .tabs div {
      flex:1; text-align:center; padding:15px;
      cursor:pointer; font-weight:500; transition:.3s;
    }
    .tabs div.active {
      background:var(--bg-light); border-bottom:3px solid #42a5f5;
    }
    .tabs.dark div.active { background:var(--header-dark); }

    .card-header {
      text-align:center; background:var(--header-light);
      padding:12px; font-size:20px; font-weight:500; transition:.3s;
    }
    .card-header.dark { background:var(--header-dark); }

    .card-body { padding:20px; transition:.3s; }
    .card-body.dark { background:var(--bg-dark); }

    label { display:block; margin-top:10px; font-weight:500; }
    textarea, select, input, button {
      width:100%; padding:10px; margin-top:5px;
      border-radius:8px; border:1px solid #ccc;
      font-size:14px; transition:.3s;
    }
    body.dark textarea,
    body.dark select,
    body.dark input {
      background:#3a3a3c; color:var(--txt-dark); border:1px solid #555;
    }
    button {
      background:var(--btn-light); color:#fff;
      border:none; cursor:pointer;
    }
    body.dark button { background:var(--btn-dark); }
    button:hover { opacity:.9; }
    .disabled { background:#eee; cursor:not-allowed; }
    .storage { display:flex; gap:10px; margin-top:10px; }
    .storage button { flex:1; }

    /* 动画样式 */
    @keyframes cardEntrance {
      0% { transform: scale(0.8); opacity:0; }
      60% { transform: scale(1.05); }
      100%{ transform: scale(1); opacity:1; }
    }
    .card { animation:cardEntrance 0.6s cubic-bezier(0.34,1.56,0.64,1); }

    @keyframes sectionSwitch {
      from { opacity:0; transform:translateX(20px); }
      to   { opacity:1; transform:translateX(0); }
    }
    .section { transition:opacity .3s, transform .3s; }
    .section.active { animation:sectionSwitch .4s ease-out; }

    @keyframes pulseGlow {
      0%   { box-shadow:0 0 0 0 rgba(66,165,245,0.4); }
      70%  { box-shadow:0 0 0 10px rgba(66,165,245,0); }
      100% { box-shadow:0 0 0 0 rgba(66,165,245,0); }
    }
    .success-pulse { animation:pulseGlow 1s ease; }

    .loading-spinner {
      width:24px; height:24px; border:3px solid #f3f3f3;
      border-top:3px solid #42a5f5; border-radius:50%;
      animation:spin 1s linear infinite; margin:0 auto;
    }
    @keyframes spin {
      0% { transform:rotate(0deg); }
      100%{ transform:rotate(360deg); }
    }

    @keyframes textFadeIn {
      from { opacity:0; transform:translateY(10px); }
      to   { opacity:1; transform:translateY(0); }
    }
    .result-fadein { animation:textFadeIn .6s ease; }

    textarea:focus {
      transform:scale(1.01);
      box-shadow:0 0 8px rgba(66,165,245,0.3);
    }
  </style>
</head>
<body>
  <div class="theme-card" id="themeCard">
    <button class="theme-btn blue selected" onclick="setTheme('blue')">🔵 浅蓝</button>
    <button class="theme-btn pink" onclick="setTheme('pink')">🌸 淡粉</button>
    <button class="theme-btn" onclick="toggleDark()">🌓 夜间</button>
    <select class="lang-select" id="langSelect" onchange="setLang(this.value)">
      <option value="zh">中文</option>
      <option value="en">English</option>
    </select>
  </div>

  <div class="card" id="mainCard">
    <div class="tabs" id="tabs">
      <div id="tab-key" class="active" onclick="showSection('key')" data-i18n="tabKey">密钥管理</div>
      <div id="tab-encrypt" onclick="showSection('encrypt')" data-i18n="tabEncrypt">加密</div>
      <div id="tab-decrypt" onclick="showSection('decrypt')" data-i18n="tabDecrypt">解密</div>
      <div id="tab-hash" onclick="showSection('hash')" data-i18n="tabHash">哈希与 HMAC</div>
      <div id="tab-qr" onclick="showSection('qr')" data-i18n="tabQR">二维码</div>
      <div id="tab-file" onclick="showSection('file')" data-i18n="tabFile">文件加解密</div>
    </div>
    <div class="card-header" id="header" data-i18n="tabKey">密钥管理</div>
    <div class="card-body" id="body">
      <!-- 密钥管理 -->
      <div id="section-key" class="section active">
        <label>选择 RSA 密钥长度：</label>
        <select id="keySize" onchange="onKeyLen()">
          <option value="">-- 请选择 --</option>
          <option>512</option><option>1024</option><option>2048</option>
        </select>
        <button id="genBtn" class="disabled" onclick="genRSA()" disabled>生成密钥对</button>
        <div class="storage">
          <button onclick="saveRSA()">💾 保存密钥</button>
          <button onclick="loadRSA()">📂 加载密钥</button>
        </div>
        <label>公钥（PEM）</label><textarea id="pubKey"></textarea>
        <label>私钥（PEM）</label><textarea id="priKey"></textarea>
      </div>

      <!-- 加密 -->
      <div id="section-encrypt" class="section">
        <label>算法：</label>
        <select id="algoEnc" onchange="togglePane('Enc')">
          <option>RSA-OAEP</option><option>RSAES-PKCS1-V1_5</option><option>AES-CBC</option>
        </select>
        <div id="rsaEncPane">
          <label>待加密明文：</label><textarea id="textInEnc"></textarea>
        </div>
        <div id="aesEncPane" style="display:none">
          <label>密码：</label><input type="password" id="aesPwdEnc"/>
          <label>待加密明文：</label><textarea id="textInAESEnc"></textarea>
        </div>
        <button onclick="doEncrypt()">加密</button>
        <label>结果(Base64)：</label><textarea id="textOutEnc" readonly></textarea>
      </div>

      <!-- 解密 -->
      <div id="section-decrypt" class="section">
        <label>算法：</label>
        <select id="algoDec" onchange="togglePane('Dec')">
          <option>RSA-OAEP</option><option>RSAES-PKCS1-V1_5</option><option>AES-CBC</option>
        </select>
        <div id="rsaDecPane">
          <label>待解密密文(Base64)：</label><textarea id="textInDec"></textarea>
        </div>
        <div id="aesDecPane" style="display:none">
          <label>密码：</label><input type="password" id="aesPwdDec"/>
          <label>待解密密文(Base64)：</label><textarea id="textInAESDec"></textarea>
        </div>
        <button onclick="doDecrypt()">解密</button>
        <label>解密结果：</label><textarea id="textOutDec" readonly></textarea>
      </div>

      <!-- 哈希与 HMAC -->
      <div id="section-hash" class="section">
        <label>选择算法：</label>
        <select id="hashAlgo"><option>SHA-256</option><option>SHA-512</option><option>MD5</option></select>
        <label>输入内容：</label><textarea id="hashInput"></textarea>
        <button id="hashBtn" onclick="generateHash()">生成哈希</button>
        <label>哈希结果：</label><textarea id="hashOutput" readonly></textarea>

        <label>选择 HMAC 算法：</label>
        <select id="hmacAlgo"><option>SHA-256</option><option>SHA-512</option><option>MD5</option></select>
        <label>密钥：</label><input type="text" id="hmacKey"/>
        <label>输入内容：</label><textarea id="hmacInput"></textarea>
        <button id="hmacBtn" onclick="generateHMAC()">生成 HMAC</button>
        <label>HMAC 结果：</label><textarea id="hmacOutput" readonly></textarea>
      </div>

      <!-- 二维码生成 -->
      <div id="section-qr" class="section">
        <label>输入文本：</label><textarea id="qrText"></textarea>
        <button onclick="generateQRCode()">生成二维码</button>
        <div id="qrCode"></div>
      </div>

      <!-- 文件加解密 -->
      <div id="section-file" class="section">
        <label>选择文件加密/解密：</label>
        <input type="file" id="fileInput"/>
        <button id="encryptFileBtn" disabled>加密文件</button>
        <button id="decryptFileBtn" disabled>解密文件</button>
        <textarea id="fileOutput" readonly></textarea>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/node-forge@1.3.1/dist/forge.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    const I18N = {
      zh:{tabKey:'密钥管理',tabEncrypt:'加密',tabDecrypt:'解密',tabHash:'哈希与 HMAC',tabQR:'二维码',tabFile:'文件加解密',dark:'夜间'},
      en:{tabKey:'Key Mgmt',tabEncrypt:'Encrypt',tabDecrypt:'Decrypt',tabHash:'Hash&HMAC',tabQR:'QR Code',tabFile:'File Enc',dark:'Dark'}
    };
    let lang='zh', rsaPub, rsaPri;

    function setLang(l){
      lang=l;
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        el.textContent=I18N[lang][el.getAttribute('data-i18n')];
      });
      const active=document.querySelector('.tabs .active').id.replace('tab-','');
      document.getElementById('header').textContent=I18N[lang]['tab'+active.charAt(0).toUpperCase()+active.slice(1)];
    }

    function setTheme(color){
      document.querySelectorAll('.theme-btn').forEach(b=>b.classList.remove('selected'));
      document.querySelector(`.theme-btn.${color}`)?.classList.add('selected');
      const map={blue:['#eaf6ff','#cfe8fc','#a5d8ff'],pink:['#fff0f5','#ffd3e0','#ffb0c9']}[color];
      document.documentElement.style.setProperty('--bg-light',map[0]);
      document.documentElement.style.setProperty('--header-light',map[1]);
      document.documentElement.style.setProperty('--btn-light',map[2]);
      document.querySelector('.tabs').style.background=map[1];
      document.querySelector('.card-header').style.background=map[1];
      document.querySelectorAll('button:not(.theme-btn)').forEach(b=>b.style.backgroundColor=map[2]);
    }

    function toggleDark(){
      document.body.style.transition='background .4s ease,color .4s ease';
      document.body.classList.toggle('dark');
      setTimeout(()=>{document.body.style.transition='';},400);
    }

    function showSection(sec){
      ['key','encrypt','decrypt','hash','qr','file'].forEach(s=>{
        document.getElementById('tab-'+s).classList.toggle('active',s===sec);
        const el=document.getElementById('section-'+s);
        el.classList.toggle('active',s===sec);
        el.querySelectorAll('.result-fadein').forEach(t=>t.classList.remove('result-fadein'));
        if(s===sec){
          el.querySelectorAll('textarea[readonly]').forEach(t=>t.classList.add('result-fadein'));
        }
      });
      document.getElementById('header').textContent=I18N[lang]['tab'+sec.charAt(0).toUpperCase()+sec.slice(1)];
    }

    function onKeyLen(){
      const ok=!!document.getElementById('keySize').value;
      document.getElementById('genBtn').disabled=!ok;
      document.getElementById('genBtn').classList.toggle('disabled',!ok);
    }
    function genRSA(){
      const sz=+document.getElementById('keySize').value;
      const kp=forge.pki.rsa.generateKeyPair({bits:sz,e:0x10001});
      rsaPub=kp.publicKey; rsaPri=kp.privateKey;
      document.getElementById('pubKey').value=forge.pki.publicKeyToPem(rsaPub);
      document.getElementById('priKey').value=forge.pki.privateKeyToPem(rsaPri);
    }
    function saveRSA(){
      localStorage.setItem('rsa_pub',document.getElementById('pubKey').value);
      localStorage.setItem('rsa_pri',document.getElementById('priKey').value);
      alert('已保存密钥');
    }
    function loadRSA(){
      const sp=localStorage.getItem('rsa_pub'), si=localStorage.getItem('rsa_pri');
      const pub=document.getElementById('pubKey'), pri=document.getElementById('priKey');
      if(sp||si){
        if(sp) pub.value=sp; if(si) pri.value=si;
        alert('已从本地加载密钥'); return;
      }
      if(pub.value.trim()||pri.value.trim()) return;
      alert('无可用密钥');
    }

    function togglePane(mode){
      ['rsa','aes'].forEach(pref=>{
        document.getElementById(pref+mode+'Pane').style.display='none';
      });
      const algo=document.getElementById('algo'+mode).value;
      const pane=(algo.startsWith('RSA')?'rsa':'aes')+mode+'Pane';
      document.getElementById(pane).style.display='block';
    }

    async function doEncrypt(){
      const btn=document.querySelector('#section-encrypt button'),
            txt=btn.innerHTML;
      try{
        btn.innerHTML='<div class="loading-spinner"></div>';
        btn.classList.add('disabled');
        // 原有加密逻辑
        let out;
        const algo=document.getElementById('algoEnc').value;
        if(algo==='AES-CBC'){
          const pwd=document.getElementById('aesPwdEnc').value,
                salt=forge.random.getBytesSync(16),
                iv=forge.random.getBytesSync(16),
                key=forge.pkcs5.pbkdf2(pwd,salt,1000,16),
                cipher=forge.cipher.createCipher('AES-CBC',key);
          cipher.start({iv});cipher.update(forge.util.createBuffer(document.getElementById('textInAESEnc').value,'utf8'));
          cipher.finish();
          const buf=forge.util.createBuffer();buf.putBytes(salt);buf.putBytes(iv);buf.putBuffer(cipher.output);
          out=forge.util.encode64(buf.getBytes());
        } else {
          loadRSA();
          const data=forge.util.encodeUtf8(document.getElementById('textInEnc').value);
          out=forge.util.encode64(rsaPub.encrypt(data,algo));
        }
        document.getElementById('textOutEnc').value=out;
        document.getElementById('textOutEnc').classList.add('success-pulse');
      } finally {
        btn.innerHTML=txt; btn.classList.remove('disabled');
      }
    }

    async function doDecrypt(){
      const btn=document.querySelector('#section-decrypt button'),
            txt=btn.innerHTML;
      try{
        btn.innerHTML='<div class="loading-spinner"></div>';
        btn.classList.add('disabled');
        let out; const algo=document.getElementById('algoDec').value;
        if(algo==='AES-CBC'){
          try {
            const pwd=document.getElementById('aesPwdDec').value,
                  data=forge.util.decode64(document.getElementById('textInAESDec').value),
                  buf=forge.util.createBuffer(data),
                  salt=buf.getBytes(16), iv=buf.getBytes(16), ct=buf.getBytes(buf.length()),
                  key=forge.pkcs5.pbkdf2(pwd,salt,1000,16),
                  decipher=forge.cipher.createDecipher('AES-CBC',key);
            decipher.start({iv});decipher.update(forge.util.createBuffer(ct));
            out=decipher.finish()?forge.util.decodeUtf8(decipher.output.getBytes()):'解密失败：密码错误或数据损坏';
          } catch{
            out='解密失败：数据格式错误';
          }
        } else {
          loadRSA();
          const buf=forge.util.decode64(document.getElementById('textInDec').value);
          out=forge.util.decodeUtf8(rsaPri.decrypt(buf,algo));
        }
        document.getElementById('textOutDec').value=out;
        document.getElementById('textOutDec').classList.add('success-pulse');
      } finally {
        btn.innerHTML=txt; btn.classList.remove('disabled');
      }
    }

    function generateHash(){
      const algo=document.getElementById('hashAlgo').value.toLowerCase().replace('-',''),
            md=forge.md[algo].create();
      md.update(document.getElementById('hashInput').value,'utf8');
      document.getElementById('hashOutput').value=md.digest().toHex();
    }

    function generateHMAC(){
      const algo=document.getElementById('hmacAlgo').value.toLowerCase().replace('-',''),
            key=document.getElementById('hmacKey').value,
            hmac=forge.hmac.create().start(algo,key);
      hmac.update(document.getElementById('hmacInput').value,'utf8');
      document.getElementById('hmacOutput').value=hmac.digest().toHex();
    }

    function generateQRCode(){
      const container=document.getElementById('qrCode');
      container.innerHTML='<div class="loading-spinner"></div>';
      setTimeout(()=>{
        const text=document.getElementById('qrText').value;
        if(!text.trim()){ return alert('请输入二维码文本'); }
        container.innerHTML='';
        QRCode.toCanvas(container,text,{},err=>{ if(err) alert('二维码生成失败'); });
        container.classList.add('result-fadein');
      },500);
    }

    const fileInput=document.getElementById('fileInput'),
          encryptFileBtn=document.getElementById('encryptFileBtn'),
          decryptFileBtn=document.getElementById('decryptFileBtn');
    fileInput.addEventListener('change',()=>{
      const hasKey=document.getElementById('priKey').value.trim();
      encryptFileBtn.disabled=!hasKey||!fileInput.files.length;
      decryptFileBtn.disabled=!hasKey||!fileInput.files.length;
    });
    encryptFileBtn.addEventListener('click',()=>{
      const f=fileInput.files[0], r=new FileReader();
      r.onload=()=>{
        const bin=r.result, combined=bin+document.getElementById('priKey').value,
              enc=btoa(combined);
        downloadBlob(enc,f.name+'.enc','application/octet-stream');
      };
      r.readAsBinaryString(f);
    });
    decryptFileBtn.addEventListener('click',()=>{
      const f=fileInput.files[0], r=new FileReader();
      r.onload=()=>{
        try {
          const enc=r.result, combined=atob(enc),
                key=document.getElementById('priKey').value;
          if(!combined.endsWith(key)) throw '';
          const bin=combined.slice(0,-key.length),
                name=f.name.endsWith('.enc')?f.name.slice(0,-4):'decrypted_'+f.name;
          downloadBlob(bin,name,'application/octet-stream');
        } catch {
          alert('文件解密失败：密钥不匹配或文件格式错误');
        }
      };
      r.readAsBinaryString(f);
    });
    function downloadBlob(base64Str,filename,mime){
      const binary=atob(base64Str), arr=new Uint8Array(binary.length);
      for(let i=0;i<binary.length;i++) arr[i]=binary.charCodeAt(i);
      const blob=new Blob([arr],{type:mime}), url=URL.createObjectURL(blob),
            a=document.createElement('a');
      a.href=url; a.download=filename; document.body.appendChild(a);
      a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>
